<!DOCTYPE html>
<html>
<head>
<!-- <script src="///code.jquery.com/jquery-1.11.2.min.js" ></script> -->
<style>
.highlight0 { background-color: #ff0000; font-size: 20pt;}
.highlight1 { background-color: #ffff00; }
.highlight2 { background-color: #80ff00; }
.highlight3 { background-color: #ff8000; }

.highlight9 { background-color: #ff0000; }
</style>

<script src="https://code.jquery.com/jquery-2.1.3.min.js" ></script>
<script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1.1','packages':['timeline']}]}"></script>
<script>
var total_on_server= 0;
var rows = [];
var queue = [];

var closure1  =
function(result){
    //console.log(result);
    //console.log( result['response']['results'].length );
    if (queue.length > 0){
        //$.getJSON(queue.pop(), closure1);
        $.getJSON(queue.shift(), closure1);
    }
    
    if ( result['response']['results'].length <= 0 ){
        return;
    }

    //console.log( 'Continue...' );

    if( total_on_server !== parseInt(result['response']['metadata']['totalresults'])){
        total_on_server = parseInt(result['response']['metadata']['totalresults']);
        log('<hr/><b><div class="highlight0">Rows: '+ total_on_server + "</div></b>");
    }
    total_on_server = parseInt(result['response']['metadata']['totalresults']);
    //console.log(result['response']['metadata']);
    //console.log(total_on_server);

    //console.log('i: ' + i + ' total_on_server: ' + total_on_server);
    //if ( i >= total_on_server){ return; }

    //console.log(result['response']['results'][0]['otype']);
    //console.log(result);

    if (result['response']['results'][0]['otype'] == "bill"){
        //console.log(result['response']['results'][0]['data']['bill']['actions'][0]['date'])
        var dateint1 = parseInt(result['response']['results'][0]['data']['bill']['actions'][0]['date']);

        log('<hr/><b><div class="highlight1">'+ new Date(dateint1)+ "</div></b>");
        rows.push([ result['response']['results'][0]['oid'], 
                new Date(dateint1),
                new Date(dateint1+(1000*60*60*24))]
        );
        //google.setOnLoadCallback(drawChart);
        drawChart();

        log('<div class="highlight1"><b>type:</b> ' + result['response']['results'][0]['otype'] + '</div>');
        log("<b>length: </b> "+ result['response']['results'].length + "</b>");
        //console.log(result['response']['results'][0]['data']['bill']['title'])
        log("<b>title:</b> " + result['response']['results'][0]['data']['bill']['title']);
        log("<b>sponsor:</b> " + result['response']['results'][0]['data']['bill']['sponsor']['fullname']);
    }
    // result['response']['results'][0]['otype']
    else if (result['response']['results'][0]['otype'] == "action"){
        var dateint1 = parseInt(result['response']['results'][0]['data']['action']['date']);
        //drawchart here
        log('<hr/><b><div class="highlight2">'+ new Date(dateint1)+ "</div></b>");
        rows.push([ result['response']['results'][0]['oid'], 
                new Date(dateint1),
                new Date(dateint1+(1000*60*60*24))]
        );
        //google.setOnLoadCallback(drawChart);
        drawChart();
        log('<div class="highlight2"><b>type:</b> ' + result['response']['results'][0]['otype'] + '</div>');
        //date=time.strftime("%x %X",time.gmtime(float(dict1['data']['action']['date'])/1000))
    }
    else if (result['response']['results'][0]['otype'] == "transcript"){
        var dateint1 = parseInt(result['response']['results'][0]['data']['transcript']['timeStamp']);
        log('<hr/><b><div class="highlight3">'+ new Date(dateint1)+ "</div></b>");
        //log('<hr/><b><div class="highlight3">'+ result['response']['results'][0]['otype'] + "</div></b>");
        //date=time.strftime("%x %X",time.gmtime(float(dict1['data']['action']['date'])/1000))
        log('<div class="highlight3"><b>type:</b> ' + result['response']['results'][0]['otype'] + '</div>');
        //drawchart here
        rows.push([ result['response']['results'][0]['oid'], 
                new Date(dateint1),
                new Date(dateint1+(1000*60*60*24))]
        );
        //google.setOnLoadCallback(drawChart);
        drawChart();
    }
    else {
        log('<hr/><b><div class="highlight9"> UNKNOWN: '+ result['response']['results'][0]['otype'] + "</div></b>");
        //date=time.strftime("%x %X",time.gmtime(float(dict1['data']['action']['date'])/1000))
    }
    log("<b>id:</b> "+ result['response']['results'][0]['oid']);
    log('<b>url:</b> <a href="' + result['response']['results'][0]['url'] + '">' + result['response']['results'][0]['url'] + '</a>');
}

function getdata(input){

window.location.hash='#'+escape(input);

$("#data").html('');
$("#timeline").html('');
rows = [];
total_on_server= 0;

for(i=1; i< 1000; i++){
//for(i=1; i< 40; i++){
//console.log(input);
queue.push( '///open.nysenate.gov/legislation/2.0/search.jsonp?pageSize=1&pageIdx='+i+'&sort=modified&sortOrder=true&term='+escape(input)+'&callback=?');
//queue.unshift( '///open.nysenate.gov/legislation/2.0/search.jsonp?pageSize=1&pageIdx='+i+'&sort=modified&sortOrder=true&term='+escape(input)+'&callback=?');
}

if (queue.length > 0){
    //$.getJSON(queue.pop(), closure1);
    $.getJSON(queue.shift(), closure1);
}

}

$( document ).ready(function() {
var input = '"message of necessity"';
if(window.location.hash.length > 1){
    //console.log(unescape(window.location.hash.substring(1)));
    input = unescape(window.location.hash.substring(1));
}
//getdata('"message of necessity"');
getdata(input);
});

function log(s){
//console.log(s)
$("#data").append(s + '<br/>');
}

      function drawChart() {
        var container = document.getElementById('timeline');
        var chart = new google.visualization.Timeline(container);
        var dataTable = new google.visualization.DataTable();

        dataTable.addColumn({ type: 'string', id: 'Event' });
        dataTable.addColumn({ type: 'date', id: 'Start' });
        dataTable.addColumn({ type: 'date', id: 'End' });
        //console.log(rows);
        dataTable.addRows( rows);

        var options = {
            timeline: { singleColor: '#8d8' },
        };
        chart.draw(dataTable,options);
      }


      function drawChartTEST() {
        var container = document.getElementById('timeline');
        var chart = new google.visualization.Timeline(container);
        var dataTable = new google.visualization.DataTable();

        dataTable.addColumn({ type: 'string', id: 'President' });
        dataTable.addColumn({ type: 'date', id: 'Start' });
        dataTable.addColumn({ type: 'date', id: 'End' });
        dataTable.addRows(
[
          [ 'Washington', new Date(1789, 3, 29), new Date(1797, 2, 3) ],
          [ 'Adams',      new Date(1797, 2, 3),  new Date(1801, 2, 3) ],
          [ 'Jefferson',  new Date(1801, 2, 3),  new Date(1809, 2, 3) ]
]
);

        chart.draw(dataTable);
      }

</script>
</head>
<body>
Search: <input onchange="getdata(this.value);" />
<!-- <div id="timeline" style="width: 900px; height: 180px;"></div> -->
<div id="timeline" style="width: 900px; height: 500px;"></div>
<div id="data"></div>
</body>
</html>
